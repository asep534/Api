<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Donation - KuroNeko</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { mono: ['"JetBrains Mono"', 'monospace'] },
                    boxShadow: { 
                        'hard': '4px 4px 0px 0px #000000', 
                        'hard-sm': '2px 2px 0px 0px #000000',
                    },
                    colors: { 'highlight': '#fbbf24', 'success': '#22c55e', 'danger': '#ef4444' },
                    transitionTimingFunction: {
                        'spring': 'cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    }
                }
            }
        }
    </script>
</head>
<body class="donasi-page min-h-screen flex items-center justify-center font-mono p-4">

    <div id="custom-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-pop">
        <div class="bg-white border-4 border-black shadow-hard w-full max-w-xs relative">
            <div class="bg-red-500 text-white px-3 py-2 border-b-4 border-black flex items-center gap-2">
                <i class="fa-solid fa-circle-exclamation"></i>
                <h3 class="font-black text-base">PERHATIAN</h3>
            </div>
            <div class="p-5 text-center">
                <p id="modal-message" class="font-bold text-gray-800 text-sm mb-5 leading-relaxed">Pesan error disini.</p>
                <button onclick="closeModal()" class="w-full bg-black text-white py-2 font-bold border-2 border-transparent hover:bg-white hover:text-black hover:border-black shadow-hard-sm transition-all text-sm">
                    MENGERTI
                </button>
            </div>
        </div>
    </div>

    <div class="bg-white border-4 border-black shadow-hard w-full max-w-[360px] md:max-w-2xl relative overflow-hidden flex flex-col transition-all duration-300">
        
        <div class="bg-highlight px-4 py-3 flex justify-between items-center border-b-4 border-black shrink-0">
            <h1 class="font-black text-xl tracking-tighter italic">DONASI</h1>
            <a href="/" class="text-[10px] font-black border-2 border-black bg-white px-2 py-1 hover:bg-black hover:text-white shadow-hard-sm transition-all no-underline text-black transform hover:-translate-y-0.5">
                HOME
            </a>
        </div>

        <div class="p-4 md:p-6 flex-grow flex flex-col justify-center">
            
            <div id="input-section" class="w-full animate-pop flex flex-col md:flex-row md:items-start gap-4 md:gap-6">
                
                <div class="w-full md:w-5/12 flex justify-center">
                    <div class="relative w-full aspect-square md:aspect-auto md:h-full border-4 border-black overflow-hidden group min-h-[200px]">
                        <img src="https://c.termai.cc/i111/TJHiBPf.jpg" class="w-full h-full object-cover grayscale transition-all duration-300 ease-spring group-hover:grayscale-0 group-hover:scale-110 cursor-pointer">
                    </div>
                </div>

                <div class="w-full md:w-7/12 space-y-3 flex flex-col justify-between h-full">
                    <div class="space-y-3">
                        <div>
                            <label class="flex items-center gap-2 font-black text-[10px] uppercase mb-1 text-gray-500">
                                Nama Pengirim
                            </label>
                            <input type="text" id="input-name" placeholder="Hamba Allah" class="w-full border-4 border-black p-2 text-sm font-bold focus:bg-yellow-50 focus:outline-none transition-colors placeholder:font-normal placeholder:text-gray-400">
                        </div>

                        <div>
                            <label class="flex items-center gap-2 font-black text-[10px] uppercase mb-1 text-gray-500">
                                Nominal Donasi
                            </label>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <button onclick="setVal(5000)" class="border-2 border-black py-1.5 text-[10px] font-black bg-gray-50 hover:bg-black hover:text-white transition-all active:scale-95">5k</button>
                                <button onclick="setVal(10000)" class="border-2 border-black py-1.5 text-[10px] font-black bg-gray-50 hover:bg-black hover:text-white transition-all active:scale-95">10k</button>
                                <button onclick="setVal(25000)" class="border-2 border-black py-1.5 text-[10px] font-black bg-gray-50 hover:bg-black hover:text-white transition-all active:scale-95">25k</button>
                            </div>
                            <div class="relative">
                                <div class="absolute left-0 top-0 bottom-0 w-10 bg-black flex items-center justify-center text-white font-black z-10 text-sm border-y-4 border-l-4 border-black">Rp</div>
                                <input type="number" id="input-amount" placeholder="1.000" class="w-full border-4 border-black p-2 pl-12 text-base font-black focus:bg-yellow-50 focus:outline-none transition-colors">
                            </div>
                        </div>
                    </div>

                    <button onclick="createTransaction()" id="btn-pay" class="mt-2 w-full bg-black text-white py-3 font-black text-sm border-2 border-transparent hover:bg-highlight hover:text-black hover:border-black shadow-hard-sm transition-all active:translate-y-1 active:shadow-none disabled:opacity-70 group">
                        <span id="btn-text">LANJUT BAYAR <i class="fa-solid fa-arrow-right ml-1"></i></span>
                        <span id="btn-loader" class="hidden"><i class="fa-solid fa-circle-notch fa-spin"></i> LOADING...</span>
                    </button>
                </div>
            </div>

            <div id="result-section" class="hidden w-full animate-pop flex-col md:flex-row gap-4 md:gap-6">
                
                <div class="w-full md:w-5/12 flex flex-col gap-2">
                    <div class="w-full bg-yellow-100 border-2 border-black border-dashed p-1.5 text-[10px] font-bold text-gray-700 text-center">
                        SCAN QRIS INI
                    </div>
                    <div class="bg-white p-2 border-4 border-black shadow-hard-sm aspect-square flex items-center justify-center">
                        <div id="qrcode" class="flex justify-center mix-blend-multiply w-full h-full items-center"></div>
                    </div>
                </div>

                <div class="w-full md:w-7/12 flex flex-col gap-3 justify-center">
                    <div class="w-full border-4 border-black bg-white p-4 shadow-hard-sm flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-bold text-gray-500 uppercase">Total Tagihan</span>
                            <span class="text-xl font-black text-black" id="display-amount">Rp 0</span>
                        </div>
                        </div>

                    <div class="w-full mt-2">
                        <button onclick="resetForm()" class="w-full bg-white text-red-500 py-3 font-bold border-2 border-black shadow-hard-sm hover:translate-y-0.5 hover:shadow-none transition-all text-xs flex items-center justify-center gap-2">
                            <i class="fa-solid fa-xmark"></i> BATALKAN TRANSAKSI
                        </button>
                    </div>
                    
                    </div>
            </div>

            <div id="success-section" class="hidden flex-col items-center justify-center text-center w-full animate-pop py-6 md:py-10">
                <div class="bg-success text-white rounded-full w-24 h-24 flex items-center justify-center border-4 border-black mb-6 shadow-hard-sm">
                    <i class="fa-solid fa-check text-5xl"></i>
                </div>
                
                <h2 class="font-black text-3xl mb-2 tracking-tight italic">ARIGATO!</h2>
                <p class="text-sm font-bold text-gray-500 mb-8 max-w-xs mx-auto">Terima kasih orang baik, donasi kamu sudah berhasil diterima.</p>
                
                <button onclick="resetForm()" class="w-full max-w-xs bg-black text-white py-3 font-black text-sm border-2 border-transparent hover:bg-white hover:text-black hover:border-black shadow-hard-sm transition-all">
                    KEMBALI DONASI
                </button>
            </div>

        </div>
    </div>

    <div class="fixed bottom-2 w-full text-center pointer-events-none md:hidden">
        <span class="text-[10px] font-black text-gray-400 opacity-50">POWERED BY KURONEKO</span>
    </div>

    <script>
        let timerInterval, expireTime;
        const LS_KEY = 'donation_session_v6_hover'; 
        
        function setVal(n) { 
            document.getElementById('input-amount').value = n; 
        }
        
        function showModal(message) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-message').innerText = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('custom-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function switchView(id) {
            ['input-section', 'result-section', 'success-section'].forEach(v => {
                const el = document.getElementById(v);
                el.classList.toggle('hidden', v !== id);
                if(v === id) {
                    el.classList.add('flex'); 
                } else {
                    el.classList.remove('flex');
                }
            });
        }

        function toggleLoading(isLoading) {
            const btn = document.getElementById('btn-pay');
            const text = document.getElementById('btn-text');
            const loader = document.getElementById('btn-loader');
            
            btn.disabled = isLoading;
            if(isLoading) {
                text.classList.add('hidden');
                loader.classList.remove('hidden');
            } else {
                text.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        function checkSession() {
            const saved = localStorage.getItem(LS_KEY);
            if (!saved) return;
            try {
                const data = JSON.parse(saved);
                if (Date.now() > data.expireTime) {
                    localStorage.removeItem(LS_KEY);
                    return;
                }
                expireTime = data.expireTime;
                renderQR(data.qr_string, data.amount);
                startTimer();
                switchView('result-section');
            } catch (e) {
                localStorage.removeItem(LS_KEY);
            }
        }

        function renderQR(qrString, amount) {
            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, {
                text: qrString,
                width: 180, height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L
            });
            document.getElementById('display-amount').innerText = "Rp " + parseInt(amount).toLocaleString('id-ID');
        }

        async function createTransaction() {
            const amount = document.getElementById('input-amount').value;
            const name = document.getElementById('input-name').value || 'Hamba Allah';

            if(!amount || amount < 1000) {
                showModal("Minimal donasi Rp 1.000 ya kak!");
                return;
            }

            toggleLoading(true);

            try {
                const response = await fetch('/api/create-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount, name: name })
                });

                const data = await response.json();

                toggleLoading(false);

                if (data.status === 'success') {
                    expireTime = data.expired_at;
                    const sessionData = {
                        order_id: data.order_id,
                        amount: data.amount,
                        qr_string: data.qr_string,
                        expireTime: expireTime
                    };
                    
                    localStorage.setItem(LS_KEY, JSON.stringify(sessionData));
                    renderQR(data.qr_string, data.amount);
                    startTimer();
                    switchView('result-section');
                } else {
                    showModal(data.message || "Terjadi kesalahan pada server.");
                }

            } catch (error) {
                toggleLoading(false);
                showModal("Gagal menghubungi server. Cek koneksi internet.");
            }
        }

        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            const updateTimer = () => {
                const now = Date.now();
                const diff = Math.ceil((expireTime - now) / 1000);
                if(diff <= 0) {
                    resetForm();
                    showModal("Waktu habis.");
                } else {
                    // Visual timer removed as requested
                    // Logic to check expiration keeps running
                }
            };
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function resetForm() {
            clearInterval(timerInterval);
            localStorage.removeItem(LS_KEY);
            document.getElementById('input-amount').value = "";
            document.getElementById('qrcode').innerHTML = "";
            switchView('input-section');
        }

        checkSession();
        if (document.getElementById('input-section').classList.contains('hidden') && 
            document.getElementById('result-section').classList.contains('hidden') && 
            document.getElementById('success-section').classList.contains('hidden')) {
             switchView('input-section');
        }
    </script>
</body>
</html>
